<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .admin-table-container { margin-top: 30px; overflow-x: auto; }
    .admin-table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .admin-table th, .admin-table td { border: 1px solid #eee; padding: 10px; text-align: right; font-size: 14px; }
    .admin-table th { background-color: #f4f8ff; color: #0a74da; font-weight: 700; }
    .action-btn { background: #f5b800; color: #000; padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; margin-left: 5px; }
    .action-btn.delete { background: #dc3545; color: white; }
    #addPropBtn { position: fixed; bottom: 30px; left: 30px; width: 60px; height: 60px; border-radius: 50%; background: #f5b800; color: #000; font-size: 30px; line-height: 60px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; border: none; z-index: 500; transition: transform 0.2s; font-weight: 700; }
    #addPropBtn:hover { transform: scale(1.1); }
    .edit-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); }
    .edit-modal-content { background-color: #fefefe; margin: 5% auto; padding: 30px; border-radius: 12px; width: 90%; max-width: 550px; position: relative; }
    .edit-modal-content .close-btn { color: #aaa; float: left; font-size: 32px; font-weight: bold; cursor: pointer; line-height: 1; }
    .edit-modal-content .close-btn:hover { color: #000; }
    .edit-modal-content .auth-area { margin-top: 10px; padding: 0; box-shadow: none; }
  </style>
</head>
<body>
  <header>
    <div class="logo"><div class="mark">ğŸ </div><div><div style="font-weight:800">Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</div></div></div>
    <div style="margin-left:auto;padding-right:16px">
      <button class="btn" id="toHome">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      <button class="btn" id="logout">Ø®Ø±ÙˆØ¬</button>
    </div>
  </header>

  <main class="container" style="max-width:90%;margin:20px auto">
    <div class="admin-table-container">
        <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</h2>
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                    <th>Ø§Ù„Ø³Ø¹Ø±</th>
                    <th>Ø§Ù„ØºØ±Ù</th>
                    <th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="adminPropsTableBody"></tbody>
        </table>
        <p id="loadingMessage" style="text-align:center; padding: 20px;">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† GitHub...</p>
    </div>
  </main>

  <button id="addPropBtn" title="Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯">+</button>

  <div id="propModal" class="edit-modal">
    <div class="edit-modal-content">
        <span class="close-btn">&times;</span>
        <div class="auth-area">
            <h3 id="modalFormTitle">Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯</h3>
            <form id="propForm">
              <input type="hidden" id="propId" />
              <input id="title" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" required />
              <input id="price" placeholder="Ø§Ù„Ø³Ø¹Ø± (Ø±Ù‚Ù… ÙÙ‚Ø·)" type="text" required />
              <input id="rooms" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„ØºØ±Ù (Ø±Ù‚Ù…)" type="number" required />
              <input id="type" placeholder="Ø§Ù„Ù†ÙˆØ¹ (apartment/villa/shop)" required />
              <input id="city" placeholder="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©/Ø§Ù„Ù…ÙˆÙ‚Ø¹" required />
              <input id="img" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (URL)" required />
              <textarea id="desc" placeholder="Ø§Ù„ÙˆØµÙ" rows="3"></textarea>
              <button class="btn" type="submit" id="submitBtn">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù‚Ø§Ø± (Ø¹Ù„Ù‰ GitHub)</button>
            </form>
        </div>
    </div>
  </div>

  <script>
    const ADMIN_EMAIL = 'admin@moazelsawy.com';
    const OWNER = 'kaidowork112'; 
    const REPO = 'Moaz-Elsawy';
    const FILE_PATH = 'data/properties.json';
    const GITHUB_TOKEN = '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';

    let currentFileSHA = null; 
    let allProperties = [];

    const propModal = document.getElementById("propModal");
    const propForm = document.getElementById("propForm");
    const modalFormTitle = document.getElementById("modalFormTitle");
    const submitBtn = document.getElementById("submitBtn");
    const loadingMessage = document.getElementById("loadingMessage");

    const user = JSON.parse(localStorage.getItem('realestate_user') || '{}');
    if(!user.is_admin || user.email !== ADMIN_EMAIL ){
      alert('ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­: Ø§Ø¯Ø®Ù„ ÙƒØ£Ø¯Ù…Ù† Ø£ÙˆÙ„Ø§Ù‹.');
      localStorage.removeItem('realestate_user');
      location.href = 'login.html';
    }

    document.getElementById("toHome").onclick = () => location.href='index.html';
    document.getElementById("logout").onclick = () => { localStorage.removeItem('realestate_user'); location.href='login.html'; }

    document.getElementById("addPropBtn").onclick = () => openModalForAdd();
    document.querySelector(".close-btn").onclick = () => propModal.style.display = 'none';
    window.onclick = (event) => { if(event.target==propModal) propModal.style.display='none'; }

    function openModalForAdd() {
        propForm.reset();
        document.getElementById("propId").value = '';
        modalFormTitle.textContent = 'Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯';
        submitBtn.textContent = 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù‚Ø§Ø± (Ø¹Ù„Ù‰ GitHub)';
        propModal.style.display = 'block';
    }

    window.editProperty = function(id) {
        const prop = allProperties.find(p => p.id === id);
        if(!prop) return;

        document.getElementById("propId").value = prop.id;
        document.getElementById("title").value = prop.title;
        document.getElementById("price").value = prop.price;
        document.getElementById("rooms").value = prop.rooms;
        document.getElementById("type").value = prop.type;
        document.getElementById("city").value = prop.city;
        document.getElementById("img").value = prop.img;
        document.getElementById("desc").value = prop.desc;

        modalFormTitle.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ';
        submitBtn.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø± (Ø¹Ù„Ù‰ GitHub)';
        propModal.style.display = 'block';
    }

    async function fetchPropertiesFromGitHub() {
        loadingMessage.style.display='block';
        const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}`;

        try {
            const response = await fetch(url, { headers: { Authorization: `token ${GITHUB_TOKEN}` }});
            if(!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            currentFileSHA = data.sha;
            const content = atob(data.content);
            allProperties = JSON.parse(content);
            displayAdminTable(allProperties);
            loadingMessage.style.display='none';
            return allProperties;
        } catch (error) {
            console.error("Failed to fetch content from GitHub:", error);
            alert("ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† GitHub. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆÙƒÙ† ÙˆØµÙ„Ø§Ø­ÙŠØ§ØªÙ‡.");
            loadingMessage.textContent='ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ Ø§Ù„ØªÙˆÙƒÙ†.';
            return [];
        }
    }

    async function updatePropertiesOnGitHub(newPropertiesArray, commitMessage) {
        if(!currentFileSHA){ alert("Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø¬Ù„Ø¨ SHA Ø§Ù„Ù…Ù„Ù. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø­ÙØ¸."); return false; }

        const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}`;
        const originalBtnText = submitBtn.textContent;
        const newContent = btoa(JSON.stringify(newPropertiesArray, null, 2));

        const payload = { message: commitMessage, content: newContent, sha: currentFileSHA };
        submitBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸... ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±';

        try {
            const response = await fetch(url, { method:'PUT', headers:{ Authorization:`token ${GITHUB_TOKEN}`, 'Content-Type':'application/json' }, body:JSON.stringify(payload) });
            if(!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const result = await response.json();
            currentFileSHA = result.content.sha;
            alert(`ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­! Commit: ${commitMessage}`);
            return true;
        } catch (error) {
            console.error("Failed to update content on GitHub:", error);
            alert("ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ GitHub.");
            return false;
        } finally { submitBtn.textContent = originalBtnText; }
    }

    function displayAdminTable(properties) {
        const tbody = document.getElementById("adminPropsTableBody");
        tbody.innerHTML='';
        if(properties.length===0){
            tbody.innerHTML='<tr><td colspan="5" style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø±Ø§Øª Ù…Ù†Ø´ÙˆØ±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</td></tr>';
            return;
        }
        properties.forEach(prop=>{
            const row = tbody.insertRow();
            row.innerHTML=`
                <td>${prop.title}</td>
                <td>${prop.price}</td>
                <td>${prop.rooms}</td>
                <td>${prop.city||'N/A'}</td>
                <td>
                    <button class="action-btn" onclick="editProperty(${prop.id})">ØªØ¹Ø¯ÙŠÙ„</button>
                    <button class="action-btn delete" onclick="deleteProperty(${prop.id})">Ø­Ø°Ù</button>
                </td>
            `;
        });
    }

    propForm.onsubmit = async (e)=>{
        e.preventDefault();
        const isEditing = document.getElementById("propId").value !== '';
        const obj = {
            id: isEditing ? Number(document.getElementById("propId").value) : Date.now(),
            title: document.getElementById("title").value,
            price: document.getElementById("price").value,
            rooms: Number(document.getElementById("rooms").value),
            type: document.getElementById("type").value,
            city: document.getElementById("city").value,
            img: document.getElementById("img").value,
            desc: document.getElementById("desc").value
        };
        let success=false;
        if(isEditing){
            const index = allProperties.findIndex(p=>p.id===obj.id);
            if(index!==-1){ allProperties[index]=obj; success=await updatePropertiesOnGitHub(allProperties, `ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø± ID: ${obj.id}`); }
        }else{
            allProperties.unshift(obj);
            success=await updatePropertiesOnGitHub(allProperties, `ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯: ${obj.title}`);
        }
        if(success){ propModal.style.display='none'; propForm.reset(); fetchPropertiesFromGitHub(); }
    }

    window.deleteProperty=async function(id){
        if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø§Ø±ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ±Ø§Ø¬Ø¹.')) return;
        const newProps = allProperties.filter(p=>p.id!==id);
        if(await updatePropertiesOnGitHub(newProps, `ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø§Ø± ID: ${id}`)){
            allProperties = newProps;
            displayAdminTable(allProperties);
        }
    }

    fetchPropertiesFromGitHub();
  </script>
</body>
</html>
