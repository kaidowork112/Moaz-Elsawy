<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</title>
<style>
body { font-family:"Cairo", sans-serif; background:#f4f8ff; margin:0; padding:0; }
header { background: linear-gradient(90deg,#0a74da,#0066cc); color:white; display:flex; justify-content:space-between; align-items:center; padding:15px 40px; }
header .logo { font-weight:700; font-size:20px; }
header .btn { background:#f5b800; color:#000; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; }
header .btn:hover { background:#ffcc33; }
.container { max-width:90%; margin:20px auto; }
.admin-table-container { margin-top:30px; overflow-x:auto; }
.admin-table { width:100%; border-collapse:collapse; background:white; box-shadow:0 2px 5px rgba(0,0,0,0.05); }
.admin-table th, .admin-table td { border:1px solid #eee; padding:10px; text-align:right; font-size:14px; }
.admin-table th { background-color:#f4f8ff; color:#0a74da; font-weight:700; }
.action-btn { background:#f5b800; color:#000; padding:6px 10px; border:none; border-radius:4px; cursor:pointer; font-size:13px; margin-left:5px; }
.action-btn.delete { background:#dc3545; color:white; }
/* Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø§Ø¦Ù… */
#addPropBtn { position:fixed; bottom:30px; left:30px; width:60px; height:60px; border-radius:50%; background:#f5b800; color:#000; font-size:30px; line-height:60px; text-align:center; box-shadow:0 4px 10px rgba(0,0,0,0.3); cursor:pointer; border:none; z-index:500; transition:transform 0.2s; font-weight:700; }
#addPropBtn:hover { transform:scale(1.1); }
/* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
.edit-modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.7); }
.edit-modal-content { background:#fefefe; margin:5% auto; padding:30px; border-radius:12px; width:90%; max-width:550px; position:relative; }
.edit-modal-content .close-btn { color:#aaa; float:left; font-size:32px; font-weight:bold; cursor:pointer; line-height:1; }
.edit-modal-content .close-btn:hover { color:#000; }
.edit-modal-content .auth-area { margin-top:10px; padding:0; box-shadow:none; }
.edit-modal-content .auth-area input, .edit-modal-content .auth-area textarea { width:100%; padding:12px; margin:8px 0; border:1px solid #ddd; border-radius:6px; font-size:16px; }
.edit-modal-content .auth-area textarea { resize:vertical; }
.edit-modal-content .auth-area button { background:#0a74da; color:white; padding:12px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
.edit-modal-content .auth-area button:hover { background:#005bb5; }
</style>
</head>
<body>
<header>
  <div class="logo">ğŸ  Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</div>
  <div>
    <button class="btn" id="toHome">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button class="btn" id="logout">Ø®Ø±ÙˆØ¬</button>
  </div>
</header>

<main class="container">
  <div class="admin-table-container">
    <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</h2>
    <table class="admin-table">
      <thead>
        <tr>
          <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
          <th>Ø§Ù„Ø³Ø¹Ø±</th>
          <th>Ø§Ù„ØºØ±Ù</th>
          <th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th>
          <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
      </thead>
      <tbody id="adminPropsTableBody"></tbody>
    </table>
    <p id="loadingMessage" style="text-align:center; padding:20px;">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† GitHub...</p>
  </div>
</main>

<button id="addPropBtn">+</button>

<div id="propModal" class="edit-modal">
  <div class="edit-modal-content">
    <span class="close-btn">&times;</span>
    <div class="auth-area">
      <h3 id="modalFormTitle">Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯</h3>
      <form id="propForm">
        <input type="hidden" id="propId" />
        <input id="title" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" required />
        <input id="price" placeholder="Ø§Ù„Ø³Ø¹Ø±" required />
        <input id="rooms" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„ØºØ±Ù" required />
        <input id="type" placeholder="Ø§Ù„Ù†ÙˆØ¹" required />
        <input id="city" placeholder="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©/Ø§Ù„Ù…ÙˆÙ‚Ø¹" required />
        <input id="img" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (URL)" required />
        <textarea id="desc" placeholder="Ø§Ù„ÙˆØµÙ" rows="3"></textarea>
        <button type="submit" id="submitBtn">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù‚Ø§Ø±</button>
      </form>
    </div>
  </div>
</div>

<script>
const ADMIN_EMAIL = 'admin@moazelsawy.com';
const OWNER = 'kaidowork112';
const REPO = 'Moaz-Elsawy';
const FILE_PATH = 'data/properties.json';
const GITHUB_TOKEN = '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';

let currentFileSHA = null;
let allProperties = [];

// Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø©
const propModal = document.getElementById('propModal');
const propForm = document.getElementById('propForm');
const modalFormTitle = document.getElementById('modalFormTitle');
const submitBtn = document.getElementById('submitBtn');
const loadingMessage = document.getElementById('loadingMessage');
const tbody = document.getElementById('adminPropsTableBody');

// ØªØ­Ù‚Ù‚ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ù…Ù†
const user = JSON.parse(localStorage.getItem('realestate_user')||'{}');
if(!user.is_admin || user.email!==ADMIN_EMAIL){
  alert('ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­: Ø§Ø¯Ø®Ù„ ÙƒØ£Ø¯Ù…Ù† Ø£ÙˆÙ„Ø§Ù‹.');
  localStorage.removeItem('realestate_user');
  location.href='login.html';
}

// ØªÙ†Ù‚Ù„
document.getElementById('toHome').onclick = () => location.href='index.html';
document.getElementById('logout').onclick = () => { localStorage.removeItem('realestate_user'); location.href='login.html'; };

// ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
document.getElementById('addPropBtn').onclick = openModalForAdd;
document.querySelector('.close-btn').onclick = () => propModal.style.display='none';
window.onclick = (e)=>{ if(e.target==propModal) propModal.style.display='none'; };

function openModalForAdd(){
  propForm.reset();
  document.getElementById('propId').value='';
  modalFormTitle.textContent='Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯';
  submitBtn.textContent='Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù‚Ø§Ø±';
  propModal.style.display='block';
}

window.editProperty = function(id){
  const prop = allProperties.find(p=>p.id===id);
  if(!prop) return;
  document.getElementById('propId').value=prop.id;
  document.getElementById('title').value=prop.title;
  document.getElementById('price').value=prop.price;
  document.getElementById('rooms').value=prop.rooms;
  document.getElementById('type').value=prop.type;
  document.getElementById('city').value=prop.city;
  document.getElementById('img').value=prop.img;
  document.getElementById('desc').value=prop.desc;
  modalFormTitle.textContent='ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ';
  submitBtn.textContent='ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±';
  propModal.style.display='block';
}

// Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† GitHub
async function fetchPropertiesFromGitHub(){
  loadingMessage.style.display='block';
  try{
    const res = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}`, {
      headers: { Authorization: `token ${GITHUB_TOKEN}` }
    });
    if(!res.ok) throw new Error('HTTP error '+res.status);
    const data = await res.json();
    currentFileSHA = data.sha;
    allProperties = JSON.parse(atob(data.content));
    displayAdminTable();
    loadingMessage.style.display='none';
  }catch(e){
    console.error(e);
    loadingMessage.textContent='ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆÙƒÙ† Ø£Ùˆ Ø§Ù„Ø§ØªØµØ§Ù„.';
  }
}

async function updatePropertiesOnGitHub(newProps, commitMsg){
  if(!currentFileSHA){ alert('Ø®Ø·Ø£: SHA ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return false; }
  const newContent = btoa(JSON.stringify(newProps,null,2));
  const payload = { message: commitMsg, content:newContent, sha:currentFileSHA };
  const origBtn = submitBtn.textContent;
  submitBtn.textContent='Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
  try{
    const res = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}`,{
      method:'PUT',
      headers:{ Authorization:`token ${GITHUB_TOKEN}`, 'Content-Type':'application/json' },
      body:JSON.stringify(payload)
    });
    if(!res.ok) throw new Error('HTTP error '+res.status);
    const result = await res.json();
    currentFileSHA=result.content.sha;
    alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!');
    return true;
  }catch(e){ console.error(e); alert('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ Ø¹Ù„Ù‰ GitHub'); return false; }
  finally{ submitBtn.textContent=origBtn; }
}

function displayAdminTable(){
  tbody.innerHTML='';
  if(allProperties.length===0){
    tbody.innerHTML='<tr><td colspan="5" style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø±Ø§Øª Ù…Ù†Ø´ÙˆØ±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</td></tr>';
    return;
  }
  allProperties.forEach(p=>{
    const row = tbody.insertRow();
    row.innerHTML=`
      <td>${p.title}</td>
      <td>${p.price}</td>
      <td>${p.rooms}</td>
      <td>${p.city||'N/A'}</td>
      <td>
        <button class="action-btn" onclick="editProperty(${p.id})">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="action-btn delete" onclick="deleteProperty(${p.id})">Ø­Ø°Ù</button>
      </td>
    `;
  });
}

// Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„
propForm.onsubmit = async (e)=>{
  e.preventDefault();
  const isEdit = document.getElementById('propId').value!=='';
  const obj={
    id: isEdit?Number(document.getElementById('propId').value):Date.now(),
    title: document.getElementById('title').value,
    price: document.getElementById('price').value,
    rooms: document.getElementById('rooms').value,
    type: document.getElementById('type').value,
    city: document.getElementById('city').value,
    img: document.getElementById('img').value,
    desc: document.getElementById('desc').value
  };
  let success=false;
  if(isEdit){
    const index = allProperties.findIndex(p=>p.id===obj.id);
    if(index!==-1){ allProperties[index]=obj; success=await updatePropertiesOnGitHub(allProperties, `ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø± ID: ${obj.id}`); }
  } else { allProperties.unshift(obj); success=await updatePropertiesOnGitHub(allProperties, `Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯: ${obj.title}`); }
  if(success){ propModal.style.display='none'; propForm.reset(); fetchPropertiesFromGitHub(); }
}

// Ø­Ø°Ù
window.deleteProperty = async function(id){
  if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø§Ø±ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ±Ø§Ø¬Ø¹.')) return;
  const newProps = allProperties.filter(p=>p.id!==id);
  if(await updatePropertiesOnGitHub(newProps, `Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø§Ø± ID: ${id}`)){ allProperties=newProps; displayAdminTable(); }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØµÙØ­Ø©
fetchPropertiesFromGitHub();
</script>
</body>
</html>
