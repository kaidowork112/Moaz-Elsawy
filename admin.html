<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Ø£Ù†Ù…Ø§Ø· Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© */
    .admin-table-container {
      margin-top: 30px;
      overflow-x: auto;
    }
    .admin-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .admin-table th, .admin-table td {
      border: 1px solid #eee;
      padding: 10px;
      text-align: right;
      font-size: 14px;
    }
    .admin-table th {
      background-color: #f4f8ff;
      color: #0a74da;
      font-weight: 700;
    }
    .action-btn {
      background: #f5b800;
      color: #000;
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      margin-left: 5px;
    }
    .action-btn.delete {
      background: #dc3545;
      color: white;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <div class="mark">ğŸ </div>
      <div><div style="font-weight:800">Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</div></div>
    </div>
    <div style="margin-left:auto;padding-right:16px">
      <button class="btn" id="toHome">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      <button class="btn" id="logout">Ø®Ø±ÙˆØ¬</button>
    </div>
  </header>

  <main class="container" style="max-width:90%;margin:20px auto">
    
    <div class="auth-area" style="max-width:700px; margin-top: 20px;">
      <h3 id="formTitle">Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯</h3>
      <form id="propForm">
        <input type="hidden" id="propId" />
        <input id="title" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" required />
        <input id="price" placeholder="Ø§Ù„Ø³Ø¹Ø± (Ø±Ù‚Ù… ÙÙ‚Ø·)" type="number" required />
        <input id="rooms" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„ØºØ±Ù (Ø±Ù‚Ù…)" type="number" required />
        <input id="type" placeholder="Ø§Ù„Ù†ÙˆØ¹ (apartment/villa/shop)" required />
        <input id="city" placeholder="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©/Ø§Ù„Ù…ÙˆÙ‚Ø¹" required />
        <input id="img" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (URL)" required />
        <textarea id="desc" placeholder="Ø§Ù„ÙˆØµÙ"></textarea>
        <button class="btn" type="submit" id="submitBtn">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù‚Ø§Ø± (Ø¹Ù„Ù‰ GitHub)</button>
      </form>
      <p style="margin-top:12px;color:#666">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§ ÙŠØªÙ… Ø­ÙØ¸Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ù…Ù„Ù <code>data/properties.json</code> Ø¹Ù„Ù‰ Ø§Ù„Ø±ÙŠØ¨Ùˆ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ.</p>
    </div>

    <div class="admin-table-container">
        <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</h2>
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                    <th>Ø§Ù„Ø³Ø¹Ø±</th>
                    <th>Ø§Ù„ØºØ±Ù</th>
                    <th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="adminPropsTableBody">
                </tbody>
        </table>
    </div>

  </main>

  <script>
    // â­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬ÙŠØªÙ‡Ø§Ø¨ - ÙŠØ¬Ø¨ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ø¨ÙŠØ§Ù†Ø§ØªÙƒ â­
    const ADMIN_EMAIL = 'admin@moazelsawy.com';
    const OWNER = 'kaidowork112'; 
    const REPO = 'Moaz-Elsawy';
    const FILE_PATH = 'data/properties.json';
    const GITHUB_TOKEN = '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'; // ØªÙˆÙƒÙ† Ù„Ù‡ ØµÙ„Ø§Ø­ÙŠØ© repo
    // ----------------------------------------------
    
    let currentFileSHA = ''; 
    let allProperties = [];
    
    // ğŸ”’ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ù…Ù† (Admin Guard)
    const user = JSON.parse(localStorage.getItem('realestate_user') || '{}');
    if(!user.is_admin || user.email !== ADMIN_EMAIL ){
      alert('ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­: Ø§Ø¯Ø®Ù„ ÙƒØ£Ø¯Ù…Ù† Ø£ÙˆÙ„Ø§Ù‹.');
      localStorage.removeItem('realestate_user');
      location.href = 'login.html';
    }
    
    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙ†Ù‚Ù„
    document.getElementById('toHome').onclick = () => location.href= 'index.html';
    document.getElementById('logout').onclick = () => { localStorage.removeItem('realestate_user'); location.href= 'login.html'; }
    
    // ==========================================================
    // Ø¯Ø§Ù„Ø© GitHub: Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    // ==========================================================
    async function fetchPropertiesFromGitHub() {
        const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}`;
        
        try {
            const response = await fetch(url, {
                headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
            });
            
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            const data = await response.json();
            currentFileSHA = data.sha; 
            
            // ÙÙƒ ØªØ´ÙÙŠØ± Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù Ù…Ù† Base64
            const content = atob(data.content); 
            allProperties = JSON.parse(content);
            
            displayAdminTable(allProperties); 
            return allProperties;

        } catch (error) {
            console.error("Failed to fetch content from GitHub:", error);
            alert("ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† GitHub. ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙˆÙƒÙ† ÙˆØ§Ù„Ø±ÙŠØ¨Ùˆ.");
            return [];
        }
    }

    // ==========================================================
    // Ø¯Ø§Ù„Ø© GitHub: Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª (PUT)
    // ==========================================================
    async function updatePropertiesOnGitHub(newPropertiesArray, commitMessage) {
        if (!currentFileSHA) {
            alert("Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø¬Ù„Ø¨ SHA Ø§Ù„Ù…Ù„Ù. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø­ÙØ¸.");
            return false;
        }

        const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}`;
        
        // ØªØ´ÙÙŠØ± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ù„Ù€ Base64
        const newContent = btoa(JSON.stringify(newPropertiesArray, null, 2));

        const payload = {
            message: commitMessage,
            content: newContent,
            sha: currentFileSHA 
        };
        
        // ØªØºÙŠÙŠØ± Ù†Øµ Ø§Ù„Ø²Ø± Ù„Ù„Ø¥Ø´Ø§Ø±Ø© Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        document.getElementById('submitBtn').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

        try {
            const response = await fetch(url, {
                method: 'PUT',
                headers: { 
                    'Authorization': `token ${GITHUB_TOKEN}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const result = await response.json();
            currentFileSHA = result.content.sha; 
            
            alert(`ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­! Commit: ${commitMessage}`);
            return true;

        } catch (error) {
            console.error("Failed to update content on GitHub:", error);
            alert("ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ GitHub. Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ ØªØ¹Ø§Ø±Ø¶.");
            return false;
        } finally {
             // Ø¥Ø¹Ø§Ø¯Ø© Ù†Øµ Ø§Ù„Ø²Ø± Ø¥Ù„Ù‰ ÙˆØ¶Ø¹Ù‡ Ø§Ù„Ø£ØµÙ„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
            document.getElementById('submitBtn').textContent = (document.getElementById('propId').value) ? 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±' : 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù‚Ø§Ø± (Ø¹Ù„Ù‰ GitHub)';
        }
    }

    // ==========================================================
    // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†
    // ==========================================================
    function displayAdminTable(properties) {
        const tbody = document.getElementById('adminPropsTableBody');
        tbody.innerHTML = '';
        
        properties.forEach(prop => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${prop.title}</td>
                <td>${prop.price}</td>
                <td>${prop.rooms}</td>
                <td>${prop.city || prop.location || 'N/A'}</td>
                <td>
                    <button class="action-btn" onclick="editProperty(${prop.id})">ØªØ¹Ø¯ÙŠÙ„</button>
                    <button class="action-btn delete" onclick="deleteProperty(${prop.id})">Ø­Ø°Ù</button>
                </td>
            `;
        });
    }

    // ==========================================================
    // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù†Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    // ==========================================================
    document.getElementById('propForm').onsubmit = async (e) => {
      e.preventDefault();
      
      const isEditing = document.getElementById('propId').value !== '';
      
      const obj = {
        id: isEditing ? Number(document.getElementById('propId').value) : Date.now(), // Ø§Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø§Ù„Ù€ ID ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        title: document.getElementById('title').value,
        price: Number(document.getElementById('price').value),
        rooms: Number(document.getElementById('rooms').value),
        type: document.getElementById('type').value,
        city: document.getElementById('city').value,
        img: document.getElementById('img').value,
        desc: document.getElementById('desc').value
      };

      if (isEditing) {
          // ØªØ¹Ø¯ÙŠÙ„: Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¨Ø§Ù„Ø¬Ø¯ÙŠØ¯
          const index = allProperties.findIndex(p => p.id === obj.id);
          if (index !== -1) {
              allProperties[index] = obj;
              await updatePropertiesOnGitHub(allProperties, `ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø± ID: ${obj.id}`);
          }
      } else {
          // Ø¥Ø¶Ø§ÙØ©: Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
          allProperties.unshift(obj);
          await updatePropertiesOnGitHub(allProperties, `ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯: ${obj.title}`);
      }
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØªÙØ±ÙŠØº Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
      resetForm();
      fetchPropertiesFromGitHub();
    }
    
    // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Ù„ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬)
    function editProperty(id) {
        const prop = allProperties.find(p => p.id === id);
        if (!prop) return;

        document.getElementById('propId').value = prop.id;
        document.getElementById('title').value = prop.title;
        document.getElementById('price').value = prop.price;
        document.getElementById('rooms').value = prop.rooms;
        document.getElementById('type').value = prop.type;
        document.getElementById('city').value = prop.city;
        document.getElementById('img').value = prop.img;
        document.getElementById('desc').value = prop.desc;
        
        document.getElementById('formTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ';
        document.getElementById('submitBtn').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø± (Ø¹Ù„Ù‰ GitHub)';
    }

    // Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù
    async function deleteProperty(id) {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø§Ø±ØŸ')) return;

        const newProps = allProperties.filter(p => p.id !== id);
        
        if (await updatePropertiesOnGitHub(newProps, `ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø§Ø± ID: ${id}`)) {
            allProperties = newProps;
            displayAdminTable(allProperties);
        }
    }

    // Ø¯Ø§Ù„Ø© ØªÙØ±ÙŠØº Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    function resetForm() {
        document.getElementById('propForm').reset();
        document.getElementById('propId').value = '';
        document.getElementById('formTitle').textContent = 'Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯';
        document.getElementById('submitBtn').textContent = 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù‚Ø§Ø± (Ø¹Ù„Ù‰ GitHub)';
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    fetchPropertiesFromGitHub();
  </script>
</body>
</html>
