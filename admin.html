<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</title>
  <style>
    :root{
      --blue:#0a74da; --gold:#f5b800; --muted:#666;
      --card:#fff; --radius:12px;
    }
    *{box-sizing:border-box;font-family:"Cairo",sans-serif}
    body{margin:0;background:#f4f6fb;padding:16px;color:#111;min-height:100vh}
    header{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:14px}
    header h1{margin:0;color:var(--blue);font-size:20px}
    .top-actions{display:flex;gap:8px;align-items:center}
    .btn{cursor:pointer;border:0;padding:8px 12px;border-radius:8px;font-weight:700}
    .btn-primary{background:var(--blue);color:white}
    .btn-danger{background:#e53e3e;color:white}
    .btn-success{background:#16a34a;color:white}
    .btn-warning{background:#f59e0b;color:white}
    .card{background:var(--card);border-radius:var(--radius);padding:14px;margin-bottom:14px;box-shadow:0 6px 20px rgba(2,6,23,.04)}
    form .row{display:flex;gap:10px;flex-wrap:wrap}
    form label{display:block;margin:8px 0 6px;font-weight:700}
    input[type="text"], input[type="number"], input[type="url"], select, textarea{
      width:100%;padding:10px;border-radius:8px;border:1px solid #dde3f0;background:#fff
    }
    textarea{min-height:72px;resize:vertical}
    /* grid properties */
    .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    .select-location{min-width:180px}
    #propertiesGrid{
      display:grid;
      gap:14px;
      grid-template-columns: repeat(1,1fr);
      margin-bottom:18px;
      max-height:520px;
      overflow:auto;
      padding-right:6px;
    }
    @media(min-width:700px){
      #propertiesGrid{grid-template-columns:repeat(2,1fr)}
    }
    .property-card{
      background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 6px 18px rgba(2,6,23,.06);display:flex;flex-direction:column;height:100%;
    }
    .property-card img{width:100%;height:170px;object-fit:cover}
    .property-body{padding:12px;flex:1;display:flex;flex-direction:column;justify-content:space-between}
    .property-title{color:var(--blue);font-weight:800;margin:0 0 6px}
    .property-meta{color:var(--muted);font-size:14px;margin-bottom:10px}
    .property-actions{display:flex;gap:8px;justify-content:flex-start}
    /* users list */
    #usersList{display:flex;flex-direction:column;gap:10px;max-height:400px;overflow:auto;padding-right:6px}
    .user-item{background:#fff;border-radius:10px;padding:10px;display:flex;flex-direction:column;gap:6px;box-shadow:0 6px 18px rgba(2,6,23,.04)}
    .user-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .user-data{font-size:14px;color:#222}
    .muted{color:var(--muted);font-size:13px}
    /* modal */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:9999;justify-content:center;align-items:center;padding:18px}
    .modal.open{display:flex}
    .modal-card{background:#fff;border-radius:12px;width:100%;max-width:520px;max-height:92vh;overflow:auto;padding:18px;position:relative}
    .modal-card img{width:100%;height:200px;object-fit:cover;border-radius:8px;margin-bottom:12px}
    .modal-close{position:absolute;left:14px;top:14px;background:#f44336;color:white;border:0;border-radius:50%;width:34px;height:34px;font-weight:800;cursor:pointer}
    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
    /* small helpers */
    .small{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>

<header>
  <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† â€” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</h1>
  <div class="top-actions">
    <button id="refreshBtn" class="btn btn-warning">ØªØ­Ø¯ÙŠØ«</button>
    <button id="logoutBtn" class="btn">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
  </div>
</header>

<!-- Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø§Ø± -->
<div class="card">
  <h3>Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯</h3>
  <form id="addForm">
    <div class="row" style="gap:12px">
      <div style="flex:1;min-width:180px">
        <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
        <input id="title" type="text" required />
      </div>
      <div style="width:150px">
        <label>Ø§Ù„Ù†ÙˆØ¹</label>
        <select id="type">
          <option value="Ø´Ù‚Ø©">Ø´Ù‚Ø©</option>
          <option value="ÙÙŠÙ„Ø§">ÙÙŠÙ„Ø§</option>
        </select>
      </div>
      <div style="width:150px">
        <label>Ø§Ù„Ù…Ø³Ø§Ø­Ø© (Ù…Â²)</label>
        <input id="area" type="number" min="0" />
      </div>
    </div>

    <div class="row" style="gap:12px">
      <div style="flex:1;min-width:180px">
        <label>Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
        <input id="location" type="text" />
      </div>
      <div style="width:150px">
        <label>Ø¹Ø¯Ø¯ Ø§Ù„ØºØ±Ù</label>
        <input id="rooms" type="number" min="0" />
      </div>
      <div style="width:180px">
        <label>Ø§Ù„Ø³Ø¹Ø±</label>
        <input id="price" type="text" />
      </div>
    </div>

    <div class="row" style="gap:12px">
      <div style="flex:1">
        <label>Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (URL)</label>
        <input id="img" type="url" />
      </div>
      <div style="width:140px;display:flex;align-items:center;gap:8px">
        <input id="showSlider" type="checkbox" />
        <label for="showSlider" class="small">Ø¥Ø¸Ù‡Ø§Ø± ÙÙŠ Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø±</label>
      </div>
    </div>

    <label>Ø§Ù„ÙˆØµÙ</label>
    <textarea id="desc"></textarea>

    <div style="margin-top:8px">
      <button class="btn btn-primary" type="submit">Ø­ÙØ¸ ÙˆØ¥Ø¶Ø§ÙØ©</button>
    </div>
  </form>
</div>

<!-- controls: location select + search -->
<div class="card controls" style="align-items:center;">
  <div>
    <label class="small">ØªØµÙÙŠØ© Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
    <select id="locationFilter" class="select-location">
      <option value="">Ø§Ù„ÙƒÙ„</option>
    </select>
  </div>

  <div style="flex:1;min-width:180px">
    <label class="small">Ø¨Ø­Ø« Ù…Ø¨Ø§Ø´Ø± (Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ Ø§Ù„Ù†ÙˆØ¹)</label>
    <input id="liveSearch" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø£Ùˆ Ø§Ù„Ù†ÙˆØ¹..." />
  </div>
</div>

<!-- grid Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª -->
<div class="card">
  <h3>Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</h3>
  <div id="propertiesGrid" aria-live="polite"></div>
</div>

<!-- Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
<div class="card">
  <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
  <div id="usersList"></div>
</div>

<footer>Â© 2025 â€” Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</footer>

<!-- modal edit -->
<div id="editModal" class="modal" role="dialog" aria-modal="true">
  <div class="modal-card" role="document">
    <button class="modal-close" title="Ø¥ØºÙ„Ø§Ù‚" onclick="closeEditModal()">Ã—</button>
    <h3 style="text-align:center;color:var(--blue);margin-top:4px">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±</h3>
    <img id="editPreview" src="" alt="ØµÙˆØ±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±" />
    <form id="editForm">
      <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
      <input id="editTitle" type="text" />

      <label>Ø§Ù„Ù†ÙˆØ¹</label>
      <select id="editType">
        <option value="Ø´Ù‚Ø©">Ø´Ù‚Ø©</option>
        <option value="ÙÙŠÙ„Ø§">ÙÙŠÙ„Ø§</option>
      </select>

      <label>Ø§Ù„Ù…Ø³Ø§Ø­Ø©</label>
      <input id="editArea" type="number" />

      <label>Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
      <input id="editLocation" type="text" />

      <label>Ø¹Ø¯Ø¯ Ø§Ù„ØºØ±Ù</label>
      <input id="editRooms" type="number" />

      <label>Ø§Ù„Ø³Ø¹Ø±</label>
      <input id="editPrice" type="text" />

      <label>Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©</label>
      <input id="editImg" type="url" />

      <label>Ø§Ù„ÙˆØµÙ</label>
      <textarea id="editDesc"></textarea>

      <div style="display:flex;gap:8px;align-items:center;margin:10px 0">
        <input id="editShowSlider" type="checkbox" />
        <label class="small">Ø¥Ø¸Ù‡Ø§Ø± ÙÙŠ Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø±</label>
      </div>

      <div style="display:flex;gap:8px;justify-content:space-between;margin-top:12px">
        <button id="saveEditBtn" class="btn btn-success" type="button">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn btn-danger" type="button" onclick="closeEditModal()">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </form>
  </div>
</div>

<!-- Firebase + logic -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
  import {
    getFirestore, collection, addDoc, getDocs, updateDoc, doc, deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBxEWaPWqpUIgZtasxnE7-82SN6OEzSx7Q",
    authDomain: "moaz-elsawy.firebaseapp.com",
    projectId: "moaz-elsawy",
    storageBucket: "moaz-elsawy.appspot.com",
    messagingSenderId: "859568017117",
    appId: "1:859568017117:web:38a7d0f7681534",
    measurementId: "G-JY1XN1VRCP"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // elements
  const addForm = document.getElementById('addForm');
  const propertiesGrid = document.getElementById('propertiesGrid');
  const locationFilter = document.getElementById('locationFilter');
  const liveSearch = document.getElementById('liveSearch');
  const usersList = document.getElementById('usersList');
  const refreshBtn = document.getElementById('refreshBtn');
  const logoutBtn = document.getElementById('logoutBtn');

  // modal elements
  const editModal = document.getElementById('editModal');
  const editPreview = document.getElementById('editPreview');
  const editForm = document.getElementById('editForm');
  const saveEditBtn = document.getElementById('saveEditBtn');

  // inputs shortcut (add form)
  const title = document.getElementById('title');
  const type = document.getElementById('type');
  const area = document.getElementById('area');
  const locationInput = document.getElementById('location');
  const rooms = document.getElementById('rooms');
  const price = document.getElementById('price');
  const img = document.getElementById('img');
  const desc = document.getElementById('desc');
  const showSlider = document.getElementById('showSlider');

  // edit inputs
  const editTitle = document.getElementById('editTitle');
  const editType = document.getElementById('editType');
  const editArea = document.getElementById('editArea');
  const editLocation = document.getElementById('editLocation');
  const editRooms = document.getElementById('editRooms');
  const editPrice = document.getElementById('editPrice');
  const editImg = document.getElementById('editImg');
  const editDesc = document.getElementById('editDesc');
  const editShowSlider = document.getElementById('editShowSlider');

  // state
  let allProperties = []; // {id, ...data}
  let allUsers = []; // {id, ...data}
  let currentEditId = null;

  // load properties & users
  async function loadProperties(){
    propertiesGrid.innerHTML = '<p class="small">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª...</p>';
    const q = await getDocs(collection(db, 'properties'));
    allProperties = q.docs.map(d => ({ id: d.id, ...d.data() }));
    populateLocationFilter();
    renderProperties();
  }

  async function loadUsers(){
    usersList.innerHTML = '<p class="small">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</p>';
    const q = await getDocs(collection(db, 'users'));
    allUsers = q.docs.map(d => ({ id: d.id, ...d.data() }));
    renderUsers();
  }

  // populate unique locations into select
  function populateLocationFilter(){
    const locations = Array.from(new Set(allProperties.map(p => (p.location || '').trim()).filter(Boolean)));
    locationFilter.innerHTML = '<option value="">Ø§Ù„ÙƒÙ„</option>';
    locations.forEach(loc=>{
      const opt = document.createElement('option'); opt.value = loc; opt.textContent = loc;
      locationFilter.appendChild(opt);
    });
  }

  // rendering properties (apply current filters)
  function renderProperties(){
    propertiesGrid.innerHTML = '';
    const searchVal = liveSearch.value.trim().toLowerCase();
    const locVal = locationFilter.value;

    const filtered = allProperties.filter(p=>{
      const byLoc = !locVal || (p.location || '').toLowerCase() === locVal.toLowerCase();
      const bySearch = !searchVal || ( (p.title||'').toLowerCase().includes(searchVal) || (p.type||'').toLowerCase().includes(searchVal) );
      return byLoc && bySearch;
    });

    if(filtered.length === 0){
      propertiesGrid.innerHTML = `<p style="text-align:center;color:var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø±Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©</p>`;
      return;
    }

    filtered.forEach(p=>{
      const card = document.createElement('div'); card.className = 'property-card';
      card.innerHTML = `
        <img src="${p.img || 'https://via.placeholder.com/400x250?text=No+Image'}" alt="${escapeHtml(p.title)}" />
        <div class="property-body">
          <div>
            <h4 class="property-title">${escapeHtml(p.title)}</h4>
            <div class="property-meta">${escapeHtml(p.type)} â€” ${p.area ? p.area + ' Ù…Â²' : '-'} â€” ${escapeHtml(p.location || '-')}</div>
            <div class="small">${escapeHtml(p.desc || '')}</div>
          </div>
          <div style="margin-top:10px" class="property-actions">
            <button class="btn btn-primary" onclick="openEditModal('${p.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="btn btn-danger" onclick="deleteProperty('${p.id}')">Ø­Ø°Ù</button>
          </div>
        </div>
      `;
      propertiesGrid.appendChild(card);
    });
  }

  // render users
  function renderUsers(){
    usersList.innerHTML = '';
    if(allUsers.length === 0){
      usersList.innerHTML = `<p class="small">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p>`;
      return;
    }
    allUsers.forEach(u=>{
      const div = document.createElement('div'); div.className = 'user-item';
      div.innerHTML = `
        <div class="user-row">
          <div style="flex:1">
            <div class="user-data"><strong>${escapeHtml(u.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…')}</strong> â€” <span class="small">${escapeHtml(u.email || '')}</span></div>
            <div class="muted">ğŸ“± ${escapeHtml(u.phone || '-')} â€” ğŸ” ${escapeHtml(u.password || '-')}</div>
            <div class="muted">ğŸ› ï¸ Ø£Ø¯Ù…Ù†: <strong>${u.isAdmin ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}</strong></div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <button class="btn ${u.isAdmin ? 'btn-warning' : 'btn-success'}" onclick="toggleAdmin('${u.id}', ${u.isAdmin})">
              ${u.isAdmin ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø£Ø¯Ù…Ù†' : 'ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†'}
            </button>
            <button class="btn btn-danger" onclick="deleteUserConfirm('${u.id}')">Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù…</button>
          </div>
        </div>
      `;
      usersList.appendChild(div);
    });
  }

  // helpers
  function escapeHtml(str){
    if(!str) return '';
    return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
  }

  // add property
  addForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const newProp = {
      title: title.value || '',
      type: type.value || '',
      area: area.value ? Number(area.value) : null,
      location: locationInput.value || '',
      rooms: rooms.value ? Number(rooms.value) : null,
      price: price.value || '',
      img: img.value || '',
      desc: desc.value || '',
      showSlider: !!showSlider.checked
    };
    try{
      await addDoc(collection(db, 'properties'), newProp);
      addForm.reset();
      await loadProperties();
      alert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù‚Ø§Ø±');
    }catch(err){
      console.error(err); alert('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù‚Ø§Ø±');
    }
  });

  // delete property
  window.deleteProperty = async (id) => {
    if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø¨Ø§Ù„ÙØ¹Ù„ØŸ')) return;
    try{
      await deleteDoc(doc(db, 'properties', id));
      await loadProperties();
    }catch(err){console.error(err); alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù')}
  };

  // open edit modal
  window.openEditModal = (id) => {
    const target = allProperties.find(x=>x.id===id);
    if(!target) return alert('ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
    currentEditId = id;
    editTitle.value = target.title || '';
    editType.value = target.type || 'Ø´Ù‚Ø©';
    editArea.value = target.area || '';
    editLocation.value = target.location || '';
    editRooms.value = target.rooms || '';
    editPrice.value = target.price || '';
    editImg.value = target.img || '';
    editDesc.value = target.desc || '';
    editShowSlider.checked = !!target.showSlider;
    editPreview.src = target.img || 'https://via.placeholder.com/600x300?text=No+Image';
    editModal.classList.add('open');
    // scroll top of modal content
    document.querySelector('.modal-card').scrollTop = 0;
  };

  window.closeEditModal = ()=>{
    editModal.classList.remove('open');
    currentEditId = null;
  };

  editImg.addEventListener('input', ()=>{ editPreview.src = editImg.value || 'https://via.placeholder.com/600x300?text=No+Image' });

  // save edit
  saveEditBtn.addEventListener('click', async ()=>{
    if(!currentEditId) return;
    const docRef = doc(db, 'properties', currentEditId);
    const updated = {
      title: editTitle.value || '',
      type: editType.value || '',
      area: editArea.value ? Number(editArea.value) : null,
      location: editLocation.value || '',
      rooms: editRooms.value ? Number(editRooms.value) : null,
      price: editPrice.value || '',
      img: editImg.value || '',
      desc: editDesc.value || '',
      showSlider: !!editShowSlider.checked
    };
    try{
      await updateDoc(docRef, updated);
      await loadProperties();
      closeEditModal();
      alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª');
    }catch(err){ console.error(err); alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„') }
  });

  // users admin toggle
  window.toggleAdmin = async (id, current) => {
    try{
      await updateDoc(doc(db, 'users', id), { isAdmin: !current });
      await loadUsers();
    }catch(err){ console.error(err); alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø£Ø¯Ù…Ù†') }
  };

  // delete user
  window.deleteUserConfirm = async (id)=>{
    if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) return;
    try{
      await deleteDoc(doc(db, 'users', id));
      await loadUsers();
    }catch(err){ console.error(err); alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…') }
  };

  // search & filter listeners
  liveSearch.addEventListener('input', ()=> renderProperties());
  locationFilter.addEventListener('change', ()=> renderProperties());

  // refresh & logout
  refreshBtn.addEventListener('click', ()=> { loadProperties(); loadUsers(); });
  logoutBtn.addEventListener('click', ()=>{
    localStorage.removeItem('realestate_user');
    alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
    location.href = 'login.html'; // or reload
  });

  // initial load
  await loadProperties();
  await loadUsers();

</script>
</body>
</html>
