<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>تسجيل/دخول | Moaz Elsawy</title>
<style>
  body { font-family: "Cairo", sans-serif; background:#f4f8ff; display:flex; justify-content:center; align-items:center; min-height:100vh; }
  .auth-container { background:white; padding:30px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.2); width:90%; max-width:400px; text-align:center; }
  h2 { color:#0a74da; margin-bottom:20px; }
  input { width:100%; padding:12px; margin:8px 0; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; }
  button { width:100%; padding:12px; background:#f5b800; border:none; border-radius:6px; cursor:pointer; font-weight:bold; margin-top:10px; }
  button:hover { background:#ffcc33; }
  .switch { margin-top:15px; color:#0a74da; cursor:pointer; text-decoration:underline; }
  .error { color:red; font-size:14px; margin-top:10px; }
</style>
</head>
<body>

<div class="auth-container">
  <h2 id="formTitle">تسجيل الدخول</h2>
  <div class="error" id="errorMsg"></div>
  <form id="authForm">
    <input type="text" id="name" placeholder="الاسم الكامل" style="display:none;" />
    <input type="email" id="email" placeholder="البريد الإلكتروني" required />
    <input type="password" id="password" placeholder="كلمة المرور" required />
    <input type="tel" id="phone" placeholder="رقم الموبايل (اختياري)" />
    <button type="submit" id="submitBtn">تسجيل الدخول</button>
  </form>
  <div class="switch" id="switchForm">ليس لديك حساب؟ سجل الآن</div>
</div>

<script>
const OWNER = 'kaidowork112';
const REPO = 'Moaz-Elsawy';
const FILE_PATH = 'data/users.json';
const GITHUB_TOKEN = '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';

let currentFileSHA = null;
let allUsers = [];
let isRegister = false;

const formTitle = document.getElementById('formTitle');
const authForm = document.getElementById('authForm');
const submitBtn = document.getElementById('submitBtn');
const switchForm = document.getElementById('switchForm');
const errorMsg = document.getElementById('errorMsg');
const nameInput = document.getElementById('name');
const phoneInput = document.getElementById('phone');
const emailInput = document.getElementById('email');
const passwordInput = document.getElementById('password');

// ===================================
// جلب بيانات المستخدمين وSHA
// ===================================
async function fetchUsers() {
  try {
    const res = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}`, {
      headers: { Authorization: `token ${GITHUB_TOKEN}` }
    });
    if (!res.ok) throw new Error('فشل جلب البيانات');
    const data = await res.json();
    currentFileSHA = data.sha;
    allUsers = JSON.parse(atob(data.content));
  } catch(e) {
    // إذا الملف غير موجود نبدأ بمصفوفة فارغة
    allUsers = [];
    currentFileSHA = null;
  }
}

// ===================================
// حفظ المستخدمين على GitHub
// ===================================
async function saveUsers(commitMsg) {
  const content = btoa(JSON.stringify(allUsers, null, 2));
  const payload = { message: commitMsg, content };
  if(currentFileSHA) payload.sha = currentFileSHA;

  try {
    const res = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}`, {
      method: 'PUT',
      headers: { Authorization: `token ${GITHUB_TOKEN}`, 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error('فشل في الحفظ على GitHub');
    const result = await res.json();
    currentFileSHA = result.content.sha;
    return true;
  } catch(e) {
    console.error(e);
    return false;
  }
}

// ===================================
// تبديل بين تسجيل الدخول والتسجيل
// ===================================
switchForm.onclick = () => {
  isRegister = !isRegister;
  if(isRegister) {
    formTitle.textContent = 'تسجيل حساب جديد';
    submitBtn.textContent = 'تسجيل';
    switchForm.textContent = 'لديك حساب بالفعل؟ تسجيل الدخول';
    nameInput.style.display = 'block';
    phoneInput.style.display = 'block';
  } else {
    formTitle.textContent = 'تسجيل الدخول';
    submitBtn.textContent = 'تسجيل الدخول';
    switchForm.textContent = 'ليس لديك حساب؟ سجل الآن';
    nameInput.style.display = 'none';
    phoneInput.style.display = 'none';
  }
  errorMsg.textContent = '';
}

// ===================================
// التعامل مع النموذج
// ===================================
authForm.onsubmit = async (e) => {
  e.preventDefault();
  errorMsg.textContent = '';

  const email = emailInput.value.trim().toLowerCase();
  const password = passwordInput.value.trim();
  const name = nameInput.value.trim();
  const phone = phoneInput.value.trim();

  await fetchUsers();

  if(isRegister) {
    if(!name) { errorMsg.textContent='أدخل الاسم الكامل'; return; }
    if(allUsers.some(u=>u.email.toLowerCase()===email)) {
      errorMsg.textContent='هذا البريد مسجل بالفعل';
      return;
    }
    const newUser = { id: Date.now(), email, password, name };
    if(phone) newUser.phone = phone;
    allUsers.push(newUser);
    const saved = await saveUsers(`تم إضافة مستخدم جديد: ${email}`);
    if(saved){
      alert('تم إنشاء الحساب بنجاح ✅');
      switchForm.click(); // العودة لتسجيل الدخول
      emailInput.value=''; passwordInput.value=''; nameInput.value=''; phoneInput.value='';
    } else {
      errorMsg.textContent='فشل إنشاء الحساب';
    }
  } else {
    // تسجيل دخول
    const user = allUsers.find(u=>u.email.toLowerCase()===email && u.password===password);
    if(user){
      localStorage.setItem('realestate_user', JSON.stringify(user));
      alert('تم تسجيل الدخول ✅');
      // إذا كنت تريد إعادة توجيه الأدمن:
      if(email==='admin@moazelsawy.com') window.location.href='admin.html';
      else window.location.href='index.html';
    } else errorMsg.textContent='بيانات الدخول غير صحيحة';
  }
}
</script>
</body>
</html>
