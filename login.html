<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>تسجيل الدخول / التسجيل | Moaz Elsawy</title>
<link rel="stylesheet" href="style.css" />
<style>
  body { background: #f4f8ff; font-family: "Cairo", sans-serif; }
  .auth-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; }
  .auth-box { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); width: 90%; max-width: 400px; text-align: center; }
  .auth-box h2 { color: #0a74da; margin-bottom: 20px; }
  .auth-box input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 6px; border: 1px solid #ccc; }
  .auth-box button { width: 100%; background: #f5b800; color: #000; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.3s; }
  .auth-box button:hover { background: #ffcc33; }
  .toggle-link { cursor: pointer; color: #0a74da; margin-top: 10px; display: block; }
  .error { color: red; font-size: 14px; margin-top: 10px; }
</style>
</head>
<body>

<div class="auth-container">
  <div class="auth-box" id="loginBox">
    <h2>تسجيل الدخول</h2>
    <form id="loginForm">
      <input type="email" id="loginEmail" placeholder="البريد الإلكتروني" required />
      <input type="password" id="loginPassword" placeholder="كلمة المرور" required />
      <div class="error" id="loginError"></div>
      <button type="submit">تسجيل الدخول</button>
    </form>
    <span class="toggle-link" id="showRegister">إنشاء حساب جديد</span>
  </div>

  <div class="auth-box" id="registerBox" style="display:none;">
    <h2>تسجيل حساب جديد</h2>
    <form id="registerForm">
      <input type="text" id="regName" placeholder="الاسم الكامل" required />
      <input type="email" id="regEmail" placeholder="البريد الإلكتروني" required />
      <input type="password" id="regPassword" placeholder="كلمة المرور" required />
      <input type="tel" id="regPhone" placeholder="رقم الهاتف (اختياري)" />
      <div class="error" id="registerError"></div>
      <button type="submit">إنشاء الحساب</button>
    </form>
    <span class="toggle-link" id="showLogin">لديك حساب بالفعل؟ تسجيل الدخول</span>
  </div>
</div>

<script>
const OWNER = 'kaidowork112';
const REPO = 'Moaz-Elsawy';
const USERS_FILE = 'data/users.json';
const GITHUB_TOKEN = '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'; // ضع توكن GitHub هنا

const ADMIN = { email: 'admin@moazelsawy.com', password: 'admin123' };

// تبديل بين تسجيل الدخول والتسجيل
document.getElementById('showRegister').onclick = () => {
  document.getElementById('loginBox').style.display = 'none';
  document.getElementById('registerBox').style.display = 'block';
};
document.getElementById('showLogin').onclick = () => {
  document.getElementById('loginBox').style.display = 'block';
  document.getElementById('registerBox').style.display = 'none';
};

// ==== تسجيل الدخول ====
document.getElementById('loginForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value.trim();
  const errorEl = document.getElementById('loginError');
  errorEl.textContent = '';

  if (email === ADMIN.email && password === ADMIN.password) {
    localStorage.setItem('realestate_user', JSON.stringify({ email, is_admin: true }));
    alert('تم تسجيل الدخول كأدمن ✅');
    window.location.href = 'admin.html';
    return;
  }

  try {
    const res = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${USERS_FILE}`, {
      headers: { Authorization: `token ${GITHUB_TOKEN}` }
    });
    if (!res.ok) throw new Error('فشل في جلب بيانات المستخدمين');
    const data = await res.json();
    const users = JSON.parse(atob(data.content));
    const user = users.find(u => u.email === email && u.password === password);
    if (!user) {
      errorEl.textContent = 'بيانات المستخدم غير صحيحة';
    } else {
      localStorage.setItem('realestate_user', JSON.stringify({ ...user, is_admin: false }));
      alert('تم تسجيل الدخول كمستخدم عادي ✅');
      window.location.href = 'index.html';
    }
  } catch (err) {
    console.error(err);
    errorEl.textContent = 'فشل الوصول إلى بيانات المستخدمين';
  }
});

// ==== التسجيل ====
document.getElementById('registerForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const name = document.getElementById('regName').value.trim();
  const email = document.getElementById('regEmail').value.trim();
  const password = document.getElementById('regPassword').value.trim();
  const phone = document.getElementById('regPhone').value.trim();
  const errorEl = document.getElementById('registerError');
  errorEl.textContent = '';

  if (!name || !email || !password) {
    errorEl.textContent = 'يرجى ملء جميع الحقول المطلوبة';
    return;
  }

  try {
    // جلب البيانات الحالية
    const res = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${USERS_FILE}`, {
      headers: { Authorization: `token ${GITHUB_TOKEN}` }
    });
    if (!res.ok) throw new Error('فشل في جلب بيانات المستخدمين');
    const data = await res.json();
    const users = JSON.parse(atob(data.content));
    const existing = users.find(u => u.email === email);
    if (existing) {
      errorEl.textContent = 'هذا البريد مستخدم مسبقاً';
      return;
    }

    const newUser = { id: Date.now(), name, email, password, phone };
    users.push(newUser);

    // تحديث GitHub
    const updateRes = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${USERS_FILE}`, {
      method: 'PUT',
      headers: { 
        Authorization: `token ${GITHUB_TOKEN}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: `إضافة مستخدم جديد: ${email}`,
        content: btoa(JSON.stringify(users, null, 2)),
        sha: data.sha
      })
    });
    if (!updateRes.ok) throw new Error('فشل في حفظ المستخدم الجديد على GitHub');

    alert('تم إنشاء الحساب بنجاح ✅');
    document.getElementById('registerForm').reset();
    document.getElementById('loginBox').style.display = 'block';
    document.getElementById('registerBox').style.display = 'none';
  } catch (err) {
    console.error(err);
    errorEl.textContent = 'فشل إنشاء الحساب';
  }
});
</script>
</body>
</html>
